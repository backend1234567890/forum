<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forum</title>
<link rel="icon" href="/logo" type="image/x-icon">
<link href='https://fonts.googleapis.com/css?family=Chela One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Chelsea Market' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Acme' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Akaya Kanadaka' rel='stylesheet'>
<style>
  body {
    margin: 0;
    padding: 0;
    background-color: rgba(9, 109, 134, 0.884);
    color: white;
    font-family: Arial, sans-serif;
  }
  .title {
    font-size: 80px;
    font-weight: bold;
    position: absolute;
    color: rgb(0, 0, 0);
    top: -8px;
    left: 20px;
    font-family: Chela One;
  }
  .username {
    font-size: 30px;
    position: absolute;
    color: rgb(0, 0, 0);
    font-family: Chelsea Market;
    top: 45px;
  }
  .container {
    width: calc(50% - 40px); /* half of the page width minus margin */
    height: calc(100vh - 120px); /* full height of the viewport minus margin */
    overflow-y: auto; /* add scrollbar if content overflows vertically */
    overflow-x: hidden;
    margin: 20px;
    padding: 10px;
    border: 1px solid white;
    position: absolute;
    top: 60px; /* push the container down to avoid overlapping with the title */
    left: 0px;
    background-color: rgba(2, 49, 16, 1);
    border-top-left-radius: 25px; 
    border-bottom-left-radius: 25px;
  }
  .container:nth-child(2) {
    left: calc(50% - 20px); /* position the second container to the right of the first one */
    border-top-right-radius: 25px; 
    border-bottom-right-radius: 25px;
    border-top-left-radius: 0px; 
    border-bottom-left-radius: 0px;
  }

  .container::-webkit-scrollbar {
    width: 8px; /* Set the width of the scrollbar */
  }

  .container::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.5); /* Set the color of the scrollbar thumb */
    border-radius: 4px; /* Rounded corners for the scrollbar thumb */
  }

  .container::-webkit-scrollbar-track {
    background-color: rgba(255, 255, 255, 0.1); /* Set the color of the scrollbar track */
  }

  .specialText::-webkit-scrollbar {
    width: 8px; /* Set the width of the scrollbar */
  }

  .specialText::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.5); /* Set the color of the scrollbar thumb */
    border-radius: 4px; /* Rounded corners for the scrollbar thumb */
  }

  .specialText::-webkit-scrollbar-track {
    background-color: rgba(255, 255, 255, 0.1); /* Set the color of the scrollbar track */
  }

  .spaceDiv::-webkit-scrollbar {
    width: 8px; /* Set the width of the scrollbar */
  }

  .spaceDiv::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.5); /* Set the color of the scrollbar thumb */
    border-radius: 4px; /* Rounded corners for the scrollbar thumb */
  }

  .spaceDiv::-webkit-scrollbar-track {
    background-color: rgba(255, 255, 255, 0.1); /* Set the color of the scrollbar track */
  }

  img {
    position: relative;
    cursor: pointer;
    top: -35px; /* Adjust top position as needed */
    left: 8px; /* Adjust left position as needed */
    width: 25px; /* Adjust image width as needed */
    height: auto; /* Maintain aspect ratio */
  }

  
  .button {
    padding: 5px 10px;
    font-family: 'Acme';
    background-color: #b12828;
    color: rgb(56, 56, 56);
    border: none;
    border-radius: 8px;
    font-size: 33px;
    cursor: pointer;
    position: absolute;
    overflow: hidden;
    transition: all 0.3s ease;
    left: calc(100% - 135px);
    top: 13.2px;
  }
  
  .button::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 300%;
    height: 300%;
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: all 0.5s ease;
    z-index: 0;
  }
  
  .button:hover::before {
    width: 0;
    height: 0;
  }
  
  .button span {
    position: relative;
    z-index: 1;
  }

  
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .topicCreate {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .topicUpdate {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .popup-content .overlay {
      text-align: center;
    }

    .close {
      position: absolute;
      top: -10px;
      right: 0px;
      cursor: pointer;
      color:black;
      font-size: 40px; /* Increase font size */
      padding: 5px; /* Increase padding */
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .editdisplayname {
        color: black;   
    }

    .confirmeditname {
        position: absolute;
        right: 21px;
        bottom: 14px;
        background-color: #723e3e;
        color: rgb(255, 255, 255);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        overflow: hidden;
        padding: 2px 4px;
        font-size: 15px;
    }

    .topicsTable td {
      height: 50px;
    }

    .topicsTable {
      width: calc(100%);
      border-collapse: collapse;
      background-color:rgba(95, 158, 160, 0.288);
      border-radius: 15px;
    }

    .topicsTable td, .topicsTable th {
        border:10px solid rgba(2, 49, 16, 1); /* Set borders for cells */
        padding: 8px; /* Optional: Add padding to cells for better spacing */
    }
    
    .topicsTable td:first-child, .topicsTable th:first-child {
        border-left: none; /* Remove left border for first column */
    }
    
    .topicsTable td:last-child, .topicsTable th:last-child {
        border-right: none; /* Remove right border for last column */
    }

    .topicsTable tr:first-child td,
    .topicsTable tr:first-child th,
    .topicsTable tr:last-child td,
    .topicsTable tr:last-child th {
        border-top: none; /* Remove top border for the first row and bottom border for the last row */
        border-bottom: none;
    }

    .topicList {
      position: relative;
      top: -8px;
      font-family: Akaya Kanadaka;
      font-size: 23px;
      text-decoration: underline;
    }

    .lastMessage {
      position: relative;
      top: 0px;
      font-family: Akaya Kanadaka;
      font-size: 18px;
      font-weight: lighter;
    }

    .addTopicBtn {
      position: absolute;
      top: calc(100% - 100px);
      left: calc(40% + 50px);
      width: 70px;
      z-index: 1;
    }

    .addTopicBtn img {
      position:fixed;
      transition: transform 0.3s ease;
    }

    .addTopicBtn:hover img {
      transform: rotate(90deg);
    }

    .messTable {
      height: auto;
    }

    #contextMenu {
      position: fixed;
      z-index: 1000;
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px 10px;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
    }

    #contextMenu div {
      cursor: pointer;
      padding: 5px;
    }

    #contextMenu div:hover {
      background-color: #f0f0f0;
    }

    #messContextMenu {
      position: fixed;
      z-index: 1000;
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px 10px;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
    }

    #messContextMenu div {
      cursor: pointer;
      padding: 5px;
    }

    #messContextMenu div:hover {
      background-color: #f0f0f0;
    }

    .options {
      color: black;
    }

    .titleDiv {
      font-family: Akaya Kanadaka;
      text-decoration: underline;
      font-size: 40px;
    }

    .descDiv {
      font-family: Akaya Kanadaka;
      font-size: 23px;
    }

    .infoDiv {
      box-shadow: 0 15px 10px -5px rgba(0, 255, 76, 0.3);
    }

    .specialText {
      width: 98.5%; /* Adjusted width */
      overflow-y: auto;
      resize: none;    
      border: 2px solid #ccc;
      border-radius: 15px;
      padding: 5px;
      font-size: 16px;
      line-height: 1.5;
      background-color: transparent;
      position: absolute;
      bottom: 10px; /* Adjust as needed */
      left: 10px; /* Adjust as needed */
      color:aquamarine
    }

    /* .messageMe {
      right: calc(0%);
      top: 0;
      position: absolute;
    } */
</style>
</head>
<body>
    <div class="title"><span id="dynamicContent"></span><span class="username" id="username"></span><img src="/editicon" alt="Edit Display Name" onclick="openPopup()"></div>
    <div class="container">
      <span class="topicSide" id="topicSide"></span>
    </div>

    <div class="container">
        <table id="topicsTable" class="topicsTable"></table>
        <div class="addTopicBtn">
          <img src="/addicon" alt="Add Topic" class="addTopicBtn" onclick="addTopicBtn()">
        </div>
    </div>
    <button class="button" id="logoutBtn"><span>Logout</span></button>
  

    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
      <div class="popup-content">
        <span class="close" onclick="closePopup()">&times;</span>
        <label for="inputField" class="editdisplayname">New Display Name: </label>
        <input type="text" id="inputField"><br><br>
        <button onclick="submitText()" class="confirmeditname">Confirm</button>
      </div>
    </div>

    <div class="topicCreate" id="topicCreate">
      <div class="popup-content">
        <span class="close" onclick="closeTopicCreate()">&times;</span>
        <label for="titlecreate" class="editdisplayname">Title&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: </label>
        <input type="text" id="titlecreate"><br><br>
        <label for="desc" class="editdisplayname">Description: </label>
        <input type="text" id="desc"><br><br>
        <button onclick="createTopic()" class="confirmeditname">Confirm</button>
      </div>
    </div>

    <div class="topicUpdate" id="topicUpdate">
      <div class="popup-content">
        <span class="close" onclick="closeTopicUpdate()">&times;</span>
        <label for="titlecreate1" class="editdisplayname">Title&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: </label>
        <input type="text" id="titlecreate1"><br><br>
        <label for="desc1" class="editdisplayname">Description: </label>
        <input type="text" id="desc1"><br><br>
        <button id="updating" class="confirmeditname">Confirm</button>
      </div>
    </div>

    <div id="contextMenu" style="display: none;">
      <div id="option1" class="options">Option 1</div>
      <div id="option2" class="options">Edit Topic</div>
      <div id="option3" class="options">Delete Topic</div>
    </div>

    <div id="messContextMenu" style="display: none;">
      <div id="mess1" class="options">Edit Message</div>
      <div id="mess2" class="options">Delete Message</div>
    </div>
</body>

<script>
    const token = localStorage.getItem('token');
    
    fetch('/user/auth/profile', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    })
    .then(data => {
        document.getElementById("dynamicContent").innerText = data.displayName;
        document.getElementById("username").innerText = data.username;
    })
    .catch(error => {
        localStorage.setItem('errorcode', 'unauthorized');
        window.location.href = '/error';
    });

    writeTopics();

    function writeTopics() {
      fetch('/user/topic/list', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'token': token
            }
      })
      .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
      })
      .then(data => {
        ////consolee.log('writeList successful:', data);
        //consolee.log(data)
        let table = document.getElementById("topicsTable");
        while (table.rows.length > 0) {
          // Remove the last row of the table
          table.deleteRow(-1);
        }
        const pos = [30, 105, 185];
        let index = -1;
        for (const topic of data.topics) {
          index += 1;
          let row = table.insertRow();
          let cell = row.insertCell();
          cell.id = JSON.stringify(topic.topicId);
          if (topic.pinned === true) {
            cell.id += ' true';
            let div3 = document.createElement("div");
            let img = document.createElement("img");
            img.src = "/pinicon"; 
            img.alt = "Pinned topic";
            img.style.position = "absolute";
            img.style.top = `calc(0% + ${pos[index]}px)`;
            img.style.left = `calc(100% - 60px)`;
            cell.appendChild(img);
            cell.appendChild(div3);
          } else {
            cell.id += ' false';
          }
          cell.classList.add(JSON.stringify(topic.topicId));

          let div = document.createElement('div');
          div.innerText = topic.title;
          div.classList.add('topicList');
          cell.appendChild(div);

          let div2 = document.createElement('div');
          const message = topic.lastMessage;
          let sender = '';
          if (!message.me) {
            sender = message.sender + ': '
          } //40
          let messBody = message.message.substring(0, 40 - sender.length);
          if (message.message.length > 40 - sender.length) {
            messBody += '...';
          }
          if (messBody.length === 0) {
            div.style.top = 0;
          }
          div2.innerText = sender + messBody;
          div2.innerText = div2.innerText.replace(/\n/g, '');
          div2.classList.add('lastMessage');
          cell.appendChild(div2);
        }
      })
      .catch(error => {
        localStorage.setItem('errorcode', 'unauthorized');
        window.location.href = '/error';
      });
      const topicsCollection = function () {
      }
    }

    function onLogout() {
        fetch('/user/auth/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'token': token
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    const errorMessage = error && error.error ? error.error : 'An error occurred';
                    throw new Error(errorMessage);
                });
            }
            return response.json();
        })
        .then(data => {
            ////consolee.log('Logout successful:', data);
            
            localStorage.removeItem('token');
            window.location.href = '/';
        })
        .catch(error => {
            localStorage.setItem('errorcode', 'unauthorized');
            window.location.href = '/error';
        });
    }

    function updateValid() {
        const validTill = parseInt(localStorage.getItem('validtill'));
        if (!validTill || Date.now() > validTill) {
            onLogout();
        }
        localStorage.setItem('validtill', Date.now() + (10 * 60 * 1000));
    }

    window.onload = function (){
        updateValid();
    }
    
    document.getElementById("logoutBtn").addEventListener("click", function(event) {
        onLogout();
    });


    function openPopup() {
      document.getElementById("popup").style.display = "block";
      document.getElementById("overlay").style.display = "block";
      document.body.style.overflow = "hidden"; // Disable scrolling
    }

    function addTopicBtn() {
      document.getElementById("topicCreate").style.display = "block";
      document.getElementById("overlay").style.display = "block";
      document.body.style.overflow = "hidden"; // Disable scrolling
    }

    function updateTopicBtn(topicId) {
      document.getElementById("topicUpdate").style.display = "block";
      document.getElementById("topicUpdate").setAttribute('topicId', topicId);
      document.getElementById("overlay").style.display = "block";
      document.body.style.overflow = "hidden"; // Disable scrolling
    }

  function closePopup() {
    document.getElementById("popup").style.display = "none";
    document.getElementById("overlay").style.display = "none";
    document.body.style.overflow = ""; // Enable scrolling
  }

  function closeTopicCreate() {
    document.getElementById("topicCreate").style.display = "none";
    document.getElementById("overlay").style.display = "none";
    document.body.style.overflow = ""; // Enable scrolling
  }

  function closeTopicUpdate() {
    document.getElementById("topicUpdate").style.display = "none";
    document.getElementById("overlay").style.display = "none";
    document.body.style.overflow = ""; // Enable scrolling
  }

  function submitText() {
    var inputText = document.getElementById("inputField").value;
    ////consolee.log("Submitted text:", inputText);
    fetch('/user/auth/profile', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        },
        body: JSON.stringify({
            'displayName': inputText
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    })
    .then(data => {
        document.getElementById("dynamicContent").innerText = data.displayName;
        document.getElementById("username").innerText = data.username;
        document.getElementById("inputField").value = "";
        closePopup();
    })
    .catch(error => {
        if (error.response && error.response.status === 401) {
            localStorage.setItem('errorcode', 'unauthorized');
            window.location.href = '/error';
        } else {
            alert(error)
        }
    });
  }

  function createTopic () {
    var newTitle = document.getElementById("titlecreate").value;
    var newDesc = document.getElementById("desc").value;
    fetch('/user/topic/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        },
        body: JSON.stringify({
            'title': newTitle,
            'description': newDesc
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    })
    .then(data => {
        writeTopics();
        closeTopicCreate();
    })
    .catch(error => {
        if (error.response && error.response.status === 401) {
            localStorage.setItem('errorcode', 'unauthorized');
            window.location.href = '/error';
        } else {
            alert(error)
        }
    });
  }
  const contextMenu = document.getElementById('contextMenu');
  const topicsTable = document.getElementById('topicsTable');
  topicsTable.addEventListener('contextmenu', (e) => {
    e.preventDefault(); // Prevent default context menu
    const targetCell = e.target.closest('td');
    if (targetCell) {
      const id = targetCell.id; // Get the topic ID from the parent cell
      const topicId = id.substring(0, id.indexOf(" "));
      contextMenu.style.left = `${e.pageX}px`; // Position the context menu
      contextMenu.style.top = `${e.pageY}px`;
      let pin = "";
      if (id.substring(id.indexOf(" ") + 1) === 'true') {
        pin = "Unpin Topic";
      } else {
        pin = "Pin Topic";
      }
      document.getElementById('option1').innerText = pin;
      document.getElementById('option1').setAttribute('data-topic-id', topicId);
      document.getElementById('option2').setAttribute('data-topic-id', topicId);
      document.getElementById('option3').setAttribute('data-topic-id', topicId);
      contextMenu.style.display = 'block'; // Display the context menu
    }
  });

  topicsTable.addEventListener('click', (e) => {
    e.preventDefault(); // Prevent default context menu
    const targetCell = e.target.closest('td');
    if (targetCell) {
      const id = targetCell.id; // Get the topic ID from the parent cell
      
      //Deleting existing data
      const topicId = id.substring(0, id.indexOf(" "));
      
      localStorage.setItem("topicid", topicId);
      var topicSide = document.getElementById("topicSide");
      while (topicSide.firstChild) {
            topicSide.removeChild(topicSide.firstChild);
      }
        
      getTopicInfo(parseInt(topicId), topicSide);
    }
  });

  function getTopicInfo (topicId, topicSide) {
    fetch('/user/topic/' + topicId + '/info', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    }).then(data => {
      //Creating new
      var newDiv = document.createElement("div");
      newDiv.classList.add("infoDiv");
      topicSide.appendChild(newDiv); 

      var titleDiv = document.createElement("div");
      var descDiv = document.createElement("div");

        // Optionally, you can add content to the inner divs
      titleDiv.textContent = data.title;
      descDiv.textContent = data.description;
      titleDiv.classList.add("titleDiv")
      descDiv.classList.add("descDiv")

        // Append the inner divs to the newly created div
      newDiv.appendChild(titleDiv);
      newDiv.appendChild(descDiv);

      var spaceDiv = document.createElement("div");

      // Set the height of the spaceDiv to fill the remaining space
      var containerHeight = topicSide.parentElement.offsetHeight; // Height of the container
      var newDivHeight = newDiv.offsetHeight; // Height of newDiv
      spaceDiv.style.backgroundColor = 'transparent';
      spaceDiv.style.overflowY = "auto";
      spaceDiv.classList.add('spaceDiv');

      var specialText = document.createElement("textarea");
      specialText.placeholder = "Type Something ...";
      specialText.style.width = "calc(95%)";
      specialText.classList.add("specialText");
      specialText.addEventListener("input", function() {
          const heighttextarea = adjustTextareaHeight(this);
          adjustSpaceDivHeight(heighttextarea, containerHeight - newDivHeight, spaceDiv);
      });
      specialText.addEventListener('keydown', function(event) {
        // Check if Enter key is pressed without Shift key
          if (event.key === 'Enter' && !event.shiftKey) {
              // Prevent default behavior of Enter key
              event.preventDefault();
              sending(topicId, specialText.value, topicSide, specialText);
          }
      });
      const heighttextarea = adjustTextareaHeight(specialText);
      adjustSpaceDivHeight(heighttextarea, containerHeight - newDivHeight, spaceDiv);
      
      // Append spaceDiv below newDiv inside topicSide
      topicSide.appendChild(spaceDiv);
      topicSide.appendChild(specialText);
      
      
      ////consolee.log(data);
      var messTable = document.createElement("table");
      messTable.classList.add("topicsTable", "messTable");
      spaceDiv.append(messTable);
      while (messTable.rows.length > 0) {
        // Remove the last row of the table
        messTable.deleteRow(-1);
      }
      let index = -1;
      for (const mess of data.messages) {
        index += 1;
        let row = messTable.insertRow();
        let cell = row.insertCell();
        cell.id = `m${mess.messageId}`
        let sender = ""
        var anotherDiv = document.createElement("div");
        if (mess.me === true) {
          cell.style.backgroundColor = "rgba(300,0,0,0.1)";
        } else {
          sender = mess.sender + ': ';
        }
        anotherDiv.innerText = sender + mess.message;
        cell.append(anotherDiv);
      }
      
      spaceDiv.scrollTop = spaceDiv.scrollHeight;
      rightClick(messTable);
    })
    .catch(error => {
        if (error.response && error.response.status === 401) {
            localStorage.setItem('errorcode', 'unauthorized');
            window.location.href = '/error';
        } else {
            alert(error);
            return "error" + error.response;
        }
    }); 
  };

  function rightClick(messageTable) {
    const messContextMenu = document.getElementById('messContextMenu');
    messageTable.addEventListener('contextmenu', handleContextMenu);
    
    function handleContextMenu(e) {
      e.preventDefault(); // Prevent default context menu
      const targetCell = e.target.closest('td'); // Get the closest cell element
      if (targetCell) {
        const messageId = targetCell.id.substring(1);
        messContextMenu.style.left = `${e.pageX}px`; // Position the context menu
        messContextMenu.style.top = `${e.pageY}px`;
        document.getElementById('mess1').innerText = messageId;
        document.getElementById('mess1').setAttribute('data-message-id', messageId);
        document.getElementById('mess2').setAttribute('data-message-id', messageId);
        messContextMenu.style.display = 'block'; // Display the context menu
      }
    }
  }


  function sending (topicId, message, topicSide, specialText) {
    fetch('/user/topic/' + topicId + '/message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        },
        body: JSON.stringify({
          message
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    }).then(data => {
      // while (topicSide.firstChild) {
      //   topicSide.removeChild(topicSide.firstChild);
      // }
      // getTopicInfo(topicId, topicSide);
      updateMessage(topicId, topicSide)
      writeTopics();
      specialText.value = "";
      var newDiv = document.getElementsByClassName("infoDiv")[0];
      var spaceDiv = document.getElementsByClassName("spaceDiv")[0];
      var containerHeight = topicSide.parentElement.offsetHeight; // Height of the container
      var newDivHeight = newDiv.offsetHeight; // Height of newDiv
      const heighttextarea = adjustTextareaHeight(specialText);
      adjustSpaceDivHeight(heighttextarea, containerHeight - newDivHeight, spaceDiv);
    })
    .catch(error => {
        if (error.response && error.response.status === 401) {
            localStorage.setItem('errorcode', 'unauthorized');
            window.location.href = '/error';
        } else {
            alert(error)
        }
    });  
  }

  function updateMessage(topicId, topicSide) {
    fetch('/user/topic/' + topicId + '/info', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    }).then(data => {
      var messTable = document.getElementsByClassName("messTable")[0];
      var spaceDiv = document.getElementsByClassName("spaceDiv")[0];
      
      while (messTable.rows.length > 0) {
        // Remove the last row of the table
        messTable.deleteRow(-1);
      }
      let index = -1;
      for (const mess of data.messages) {
        index += 1;
        let row = messTable.insertRow();
        let cell = row.insertCell();
        cell.id = `m${mess.messageId}`;
        let sender = ""
        var anotherDiv = document.createElement("div");
        if (mess.me === true) {
          cell.style.backgroundColor = "rgba(300,0,0,0.1)";
        } else {
          sender = mess.sender + ': ';
        }
        anotherDiv.innerText = sender + mess.message;
        cell.append(anotherDiv);
      }
      
      spaceDiv.scrollTop = spaceDiv.scrollHeight;
      rightClick(messTable);
    }).catch(error => {
      if (error.response && error.response.status === 401) {
        localStorage.setItem('errorcode', 'unauthorized');
        window.location.href = '/error';
      } else {
        alert(error)
      }
    }); 
  }

  function adjustTextareaHeight(textarea) {
    textarea.style.height = "auto";
    ////consolee.log(textarea.scrollHeight);
    let number = 0;
    if (textarea.scrollHeight != 0) {
      number = textarea.scrollHeight - 10;
    } else {
      number = 34;
    }
    textarea.style.height = Math.min(number, 7 * parseFloat(window.getComputedStyle(textarea).lineHeight)) + "px";
    return textarea.clientHeight;
  }

  function adjustSpaceDivHeight(heighttextarea, existingarea, spaceDiv) {
    let addition = 0;
    if (heighttextarea === 0) {
      addition = 100;
    } else {
      addition = 42;
    }
    spaceDiv.style.height = `${existingarea - heighttextarea - addition}px`;
  }

  document.addEventListener('click', (e) => {
      if (!contextMenu.contains(e.target)) {
        contextMenu.style.display = 'none';
      }
      if (!messContextMenu.contains(e.target)) {
        messContextMenu.style.display = 'none';
      }
  });

  function pinning(topicId) {
    fetch('/user/topic/' + topicId + '/pin', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    }).then(data => {
        writeTopics();
    })
    .catch(error => {
        if (error.response && error.response.status === 401) {
            localStorage.setItem('errorcode', 'unauthorized');
            window.location.href = '/error';
        } else {
            alert(error)
        }
    });    
  }

  function deleting (topicId) {
    fetch('/user/topic/' + topicId, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    }).then(data => {
        writeTopics();
    })
    .catch(error => {
        if (error.response && error.response.status === 401) {
            localStorage.setItem('errorcode', 'unauthorized');
            window.location.href = '/error';
        } else {
            alert(error)
        }
    });       
  }

  function updating (topicId) {
    var newTitle = document.getElementById("titlecreate1").value;
    var newDesc = document.getElementById("desc1").value;

    fetch('/user/topic/' + topicId, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        },
        body: JSON.stringify({
            'title': newTitle,
            'description': newDesc
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    }).then(data => {
        writeTopics();
        document.getElementById("desc1").value="";
        document.getElementById("titlecreate1").value="";
        closeTopicUpdate();
    })
    .catch(error => {
        if (error.response && error.response.status === 401) {
            localStorage.setItem('errorcode', 'unauthorized');
            window.location.href = '/error';
        } else {
            alert(error)
        }
    });       
  }

  document.getElementById("updating").addEventListener('click', () => {
    const topicId = document.getElementById("topicUpdate").getAttribute('topicId');
    updating(topicId);
  })

  document.querySelectorAll('#contextMenu div').forEach(option => {
    option.addEventListener('click', (e) => {
      const optionId = e.target.id; // Get the ID of the clicked option
      const topicId = e.target.getAttribute('data-topic-id');
      if (optionId === 'option1') {
        pinning(topicId);
      } else if (optionId === 'option2') {
        updateTopicBtn(topicId);
      } else if (optionId === 'option3') {
        deleting(topicId);
      }
      contextMenu.style.display = 'none';
    });
  });

  function deleteMessage (messageId) {
    const topicId = localStorage.getItem('topicid');

    fetch('/user/topic/' + topicId + '/message/' + messageId, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'token': token
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                const errorMessage = error && error.error ? error.error : 'An error occurred';
                throw new Error(errorMessage);
            });
        }
        return response.json();
    }).then(data => {
        writeTopics();
        updateMessage(parseInt(localStorage.getItem('topicid')), document.getElementById("topicSide"));
    })
    .catch(error => {
        if (error.response && error.response.status === 401) {
            localStorage.setItem('errorcode', 'unauthorized');
            window.location.href = '/error';
        } else {
            alert(error)
        }
    }); 
  }

  document.querySelectorAll('#messContextMenu div').forEach(option => {
    option.addEventListener('click', (e) => {
      const optionId = e.target.id; // Get the ID of the clicked option
      const messageId = e.target.getAttribute('data-message-id');
      if (optionId === 'mess2') {
        deleteMessage(messageId);
      }
      messContextMenu.style.display = 'none';
    });
  });


  function routine() {
    //consolee.log(localStorage.getItem('topicid'));
    if (localStorage.getItem('topicid') && topicSide.firstChild) {
      updateMessage(parseInt(localStorage.getItem('topicid')), document.getElementById("topicSide"));
    }
    writeTopics();
  }
  setInterval(routine, 6000); 
</script>
</html>
